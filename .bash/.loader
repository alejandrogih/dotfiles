#!/usr/bin/env bash
# netj's bash module loader
# Author: Jaeho Shin <netj@sparcs.kaist.ac.kr>
# Created: 2004-05-27

# prepare
# module loader/unloader
bash_noop() { false; }
bash_prepare_fallback() {
    bash_import() { bash_noop; }
    bash_login() { bash_noop; }
    bash_load() { bash_noop; }
}
bash_load_module_begin() {
    if [ "$bash_module" != "$1" ]; then
        # load module from file
        bash_module=$1
        bash_prepare_fallback
        . ~/.bash/"$bash_module"
        # disable module if neither enabled nor autoloaded
        local switch="${bash_module//[^A-Za-z0-9]/_}_enable"
        if ! ${!switch:-${bash_autoload:-false}}; then
            bash_prepare_fallback
        fi
    fi
}
bash_load_module_end() {
    # clear handlers
    unset bash_module bash_autoload bash_import bash_load bash_login
}
# iterator
shopt -s extglob
bash_foreach_modules() {
    local m=
    # TODO order by dependency
    for m in ~/.bash/!(.loader|.profile|.logout|README); do
        [ -f "$m" ] || continue
        m=${m#~/.bash/}
        bash_load_module_begin "$m"
        "$@"
        bash_load_module_end "$m"
    done
}

# declaring default options
bash_default() {
    local name=$1
    local value=$2
    if [ -n "${!name}" ]; then
        false
    else
        eval "$name='${value//\'/\'\\\'\'}'"
        true
    fi
}
bash_default_env() {
    bash_default "$@"
    export $1
}
bash_default_alias() {
    alias "$1" 2>/dev/null >&2 || alias "$1"="$2"
}

# registering handlers
PROMPT_COMMAND=""
bash_unload_command=""
trap 'eval $bash_unload_command' EXIT
bash_add_unloader() {
    bash_unload_command="$bash_unload_command$1;"
}
bash_insert_prompt() {
    PROMPT_COMMAND="$1;$PROMPT_COMMAND"
}
bash_add_prompt() {
    PROMPT_COMMAND="$PROMPT_COMMAND$1;"
}

# now, load everything
bash_foreach_modules eval "bash_import"
bash_foreach_modules eval "bash_load"
# detect login shells
! shopt -q login_shell || bash_foreach_modules eval "bash_login"

# clean up what should not be left
unset bash_noop bash_prepare_fallback \
    bash_load_module_begin bash_load_module_end bash_foreach_modules \
    bash_default bash_default_env bash_default_alias \
    bash_add_unloader bash_insert_prompt bash_add_prompt

# vim:et:ts=8:sw=4:sts=4
